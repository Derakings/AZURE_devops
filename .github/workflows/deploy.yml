name: CD - Build & Deploy to OpenShift

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/task-api
  OPENSHIFT_NAMESPACE: task-api

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ github.sha }}
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./python-task-api
          file: ./python-task-api/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Image digest
        run: echo "Pushed image ${{ env.IMAGE_NAME }}:${{ github.sha }}"

  deploy:
    name: Deploy to OpenShift
    needs: build-and-push
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@main
        with:
          oc: latest

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}

      - name: Switch to project
        run: |
          oc project ${{ env.OPENSHIFT_NAMESPACE }} || oc new-project ${{ env.OPENSHIFT_NAMESPACE }}

      - name: Create Docker registry secret
        run: |
          oc create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --docker-email=ignored@example.com \
            -n ${{ env.OPENSHIFT_NAMESPACE }} \
            --dry-run=client -o yaml | oc apply -f -

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update image in kustomization
        run: |
          cd k8s-manifests/apps/task-api/base
          kustomize edit set image task-api=${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}
          kustomize build . > deployment.yaml
          cat deployment.yaml

      - name: Deploy application
        run: |
          oc apply -k k8s-manifests/apps/task-api/base -n ${{ env.OPENSHIFT_NAMESPACE }}

      - name: Wait for rollout
        run: |
          echo "Waiting for deployment to roll out..."
          oc rollout status deployment/task-api -n ${{ env.OPENSHIFT_NAMESPACE }} --timeout=5m || true

      - name: Verify deployment
        run: |
          echo "=== Deployments ==="
          oc get deployment -n ${{ env.OPENSHIFT_NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ env.OPENSHIFT_NAMESPACE }}
          echo ""
          echo "=== Services ==="
          oc get svc -n ${{ env.OPENSHIFT_NAMESPACE }}
          echo ""
          echo "=== Routes ==="
          oc get route -n ${{ env.OPENSHIFT_NAMESPACE }} || echo "No routes yet"

      - name: Expose service as route
        run: |
          # Create route if it doesn't exist
          oc expose service task-api -n ${{ env.OPENSHIFT_NAMESPACE }} --overrides='{"apiVersion":"route.openshift.io/v1"}' || oc get route task-api -n ${{ env.OPENSHIFT_NAMESPACE }}

      - name: Get application URL
        run: |
          echo "=== Application URL ==="
          APP_URL=$(oc get route task-api -n ${{ env.OPENSHIFT_NAMESPACE }} -o jsonpath='{.spec.host}' 2>/dev/null || echo "Route not ready")
          echo "Application URL: https://$APP_URL"
          echo "Swagger Docs: https://$APP_URL/docs"
          echo "Health Check: https://$APP_URL/health"

      - name: Test health endpoint
        run: |
          APP_URL=$(oc get route task-api -n ${{ env.OPENSHIFT_NAMESPACE }} -o jsonpath='{.spec.host}' 2>/dev/null)
          if [ ! -z "$APP_URL" ]; then
            echo "Testing health endpoint..."
            sleep 10
            curl -k https://$APP_URL/health || echo "Health check endpoint not yet available"
          fi
        continue-on-error: true
